!function(t,e){function a(){}var r={Argentina:"ar",Bangladesh:"bd",Austria:"at",Australia:"au",Belgium:"be",Bulgaria:"bg",Chile:"cl",Denmark:"dk","Hong Kong":"hk",Ireland:"ie",Israel:"il",Iran:"ir",Italy:"it","South Korea":"kr",Korea:"kr",Luxembourg:"lu",Latvia:"lv",Mexico:"mx",Malaysia:"my",Netherlands:"nl",Norway:"no",Peru:"pe",Poland:"pl","Puerto Rico":"pr",Russia:"ru","Saudi Arabia":"sa",Serbia:"rs",Slovenia:"si",Slovakia:"sk",Senegal:"sn",USA:"us",France:"fr","United Kingdom":"gb",Spain:"es",India:"in","Sri Lanka":"lk",Germany:"de",Canada:"ca",Nepal:"np",Pakistan:"pk",Brazil:"br",China:"cn",Switzerland:"ch",Singapore:"sg","New Zealand":"nz",Japan:"jp","Czech Republic":"cz",Sweden:"se",Turkey:"tr",Greece:"gr",Cyprus:"cy",Ukraine:"ua",Taiwan:"tw",Suriname:"sr",Romania:"ro",Indonesia:"id",Liechtenstein:"li",Philippines:"ph","South Africa":"za",Tanzania:"tz",Portugal:"pt",Hungary:"hu",Venezuela:"ve",Croatia:"hr",Ecuador:"ec",Egypt:"eg",Estonia:"ee",Finland:"fi",Georgia:"ge",Malta:"mt",Morocco:"ma","Dominican Republic":"do"};a.prototype.init=function(t){if(0===t.length)throw new Error("Empty dataset");this.data=t.requests,this.filters={}},a.prototype.groupBy=function(t,e){function a(t,e){l[t[e]]||(l[t[e]]=[0,0,0])}function r(t,e){a(t,e);var r;switch(t.disclosed){case"All":r=0;break;case"No":r=1;break;case"Partial":r=2}l[t[e]][r]+=1}if(!this.data[0][t])throw new Error('No such column in dataset: "'+t+'" in: '+Object.keys(this.data[0]).join(", "));var n=this.data,l={};for(var i in n){var o=n[i],s=!1;if(void 0===this.filters||0===this.filters.length)s=!0;else{var u=!0;for(var c in this.filters){var p=this.filters[c];p!==o[c]&&(u=!1)}u&&(s=!0)}s?r(o,t):("undefined"==typeof this.filters.duration||o.duration===this.filters.duration)&&a(o,t)}if(e){var d=[];for(var i in l)d.push({key:i,value:l[i]});return d}return l},horizontalGraph=function(a,n,l,i,o){function s(a,l,i,s,u,d,y){function m(t,e){return k.filter(function(a){return a.key===t&&a.disclosed===e})[0]}var h=40*l.length+40;c.height(h),v.attr("height",h),y===!0&&(C=t.scale.linear().domain([0,t.max(l,function(t){var e=t.value.reduce(function(t,e){return t+e});return e})]).range([20,f]));for(var _=[],g=0;g<l.length;g++)_.push(g);var i=t.scale.ordinal().domain(l.map(function(t){return t.key})).range(_),k=(a.append("line").attr("class","left-line").attr("x1",0).attr("x2",0).attr("y1",20).attr("y2",h-10),[]),x=[];l.forEach(function(t){x[t.key]=t.value[0]+t.value[1],k.push({key:t.key,disclosed:"all",value:t.value[0],x:t.value[1]+t.value[2]}),k.push({key:t.key,disclosed:"partial",value:t.value[2],x:t.value[1]}),k.push({key:t.key,disclosed:"no",value:t.value[1],x:0})});var q=a.selectAll("rect."+d).data(k,function(t){return t.key+t.disclosed});q.enter().append("rect").on("click",function(t){s.filters[n]===t.key?delete s.filters[n]:s.filters[n]=t.key,u.filter()}).attr("class",d),q.on("mouseover",function(a){var r="",n=Number(m(a.key,"all").value),l=Number(m(a.key,"partial").value),i=Number(m(a.key,"no").value),u=e(t.event.target).offset().top,c=b+C(x[a.key]);if(c+=p?50:30,p&&0!==Object.keys(s.filters).length&&"undefined"!=typeof s.filters.type){var d=s.groupBy("country")[a.key],f=s.filters.type;r="<b>"+f+"</b><span>"+(Number(d[0])+Number(d[1])+Number(d[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+d[0]+"</span><b class='partial-data'>"+e("#t_information_produced_partial").val()+"</b><span class='partial-data'>"+d[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+'</span><b class="partial-data">'+e("#t_information_produced_partial").val()+'</b><span class="partial-data">'+l+"</span>"),o.html(r).style("top",u+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return o.style("display","none")}).attr("height","12").attr("y",function(t){return 40*(i(t.key)+1)+3}).classed("disclosed--all",function(t){return"all"===t.disclosed}).classed("disclosed--partial",function(t){return"partial"===t.disclosed}).classed("disclosed--none",function(t){return"no"===t.disclosed}).transition().attr("x",function(t){return C(t.x)-20}).attr("width",function(t){return 0===t.value?0:C(t.value)}),q.exit().remove();var A=a.selectAll("text."+d).data(l);if(A.enter().append("text").on("click",function(t){s.filters[n]===t.key?delete s.filters[n]:s.filters[n]=t.key,u.filter()}).attr("class",d),A.on("mouseover",function(a){var r="",n=Number(m(a.key,"all").value),l=Number(m(a.key,"partial").value),i=Number(m(a.key,"no").value),u=e(t.event.target).offset().top+20,c=b+C(x[a.key]);if(c+=p?50:30,p&&0!==Object.keys(s.filters).length&&"undefined"!=typeof s.filters.type){var d=s.groupBy("country")[a.key],f=s.filters.type;r="<b>"+f+"</b><span>"+(Number(d[0])+Number(d[1])+Number(d[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+d[0]+"</span><b class='partial-data'>"+e("#t_information_produced_partial").val()+"</b><span class='partial-data'>"+d[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+'</span><b class="partial-data">'+e("#t_information_produced_partial").val()+'</b><span class="partial-data">'+l+"</span>"),o.html(r).style("top",u+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return o.style("display","none")}).attr("y",function(t,e){return 40*(e+1)}).attr("dy",-3).attr("x",5).text(function(t){var a="#t_";return a+=t.key.replace(/\W+/g," ").split(" ").join("_").toLowerCase(),e(a).val()}),A.exit().remove(),p){var w=a.selectAll("image."+d).data(l);w.enter().append("image").on("click",function(t){s.filters[n]===t.key?delete s.filters[n]:s.filters[n]=t.key,u.filter()}).attr("class",d).classed("flag",!0).each(function(t,e){"undefined"!=typeof r[t.key.split("*")[0]]&&a.append("rect").attr({"class":"flagBorder",width:"24",height:"18",y:function(){return 40*(e+1)-8},x:"-33"})}),w.on("mouseover",function(a){var r="",n=Number(m(a.key,"all").value),l=Number(m(a.key,"partial").value),i=Number(m(a.key,"no").value),u=e(t.event.target).offset().top+10,c=b+C(x[a.key]);if(c+=p?50:30,p&&0!==Object.keys(s.filters).length&&"undefined"!=typeof s.filters.type){var d=s.groupBy("country")[a.key],f=s.filters.type;r="<b>"+f+"</b><span>"+(Number(d[0])+Number(d[1])+Number(d[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+d[0]+"</span><b>"+e("#t_information_produced_partial").val()+"</b><span>"+d[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+"</span><b>"+e("#t_information_produced_partial").val()+"</b><span>"+l+"</span>"),o.html(r).style("top",u+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return o.style("display","none")}).attr("width",24).attr("height",18).attr("xlink:href",function(t){return"undefined"!=typeof r[t.key.split("*")[0]]?"./images/flags_svg/"+r[t.key.split("*")[0]]+".svg":void 0}).attr("y",function(t,e){return 40*(e+1)-8}).attr("x",-33),w.exit().remove()}}for(var u=l.groupBy(n,!0),c=e("#"+a),p=Object.keys(r).indexOf(u[0].key)>-1,d={top:10,right:10,bottom:10,left:p?40:20},f=c.width()-d.left-d.right,y=c.height()-d.top-d.bottom,v=t.select("#"+a).append("svg").attr("width",f+d.left+d.right).attr("height",y+d.top+d.bottom),m=v.append("g").attr("transform","translate("+d.left+","+d.top+")"),b=e(v[0]).offset().left,h=(m.append("line").attr("class","left-line").attr("x1",0).attr("x2",0).attr("y1",20).attr("y2",y-10),[]),_=0;_<u.length;_++)h.push(_);var g=t.scale.ordinal().domain(u.map(function(t){return t.key})).range(h),C=t.scale.linear().domain([0,t.max(u,function(t){var e=t.value.reduce(function(t,e){return t+e});return e})]).range([0,f]);s(m,u,g,l,i,"gray_bars",!0),s(m,u,g,l,i,"blue_bars",!0),i.on("filter."+a,function(){var t=l.groupBy(n,!0);s(m,t,g,l,i,"blue_bars")}),i.on("timerange."+a,function(){var t=l.groupBy(n,!0);s(m,t,g,l,i,"gray_bars",!0),s(m,t,g,l,i,"blue_bars",!0)})},bubbleGraph=function(a,r,n,l){function i(a){var r=a,n=t.max(r,function(t){return t.requests}),i=n/4,o=n/2,c=i;r.forEach(function(t){c+=t.requests/2,t.x=c,c+=t.requests/2,c+=i});var y=t.scale.linear().domain([0,c]).range([0,s]),v=t.scale.linear().domain([0,n]).range([0,u]);r.forEach(function(t){y(t.requests/2)<40&&(t.tiny=!0)});var m=p.selectAll("circle.all_requests").data(r,function(t){return t.company});m.enter().append("circle").attr("class","all_requests").attr("cx",function(t){return y(t.x)}).attr("cy",function(){return v(o)}).attr("r",0),m.on("mouseover",function(t){return l.html("<b>"+e("#t_total_requests").val()+"</b><span>"+t.requests+"</span><b>"+e("#t_information_produced").val()+"</b><span>"+t.complied+"</span>").style("top",f-y(t.requests/2)+20+"px").style("left",d+y(t.x)-60+"px").style("display","block")}).on("mouseout",function(){return l.style("display","none")}).transition().attr("cx",function(t){return y(t.x)}).attr("cy",function(){return v(o)}).attr("r",function(t){return 2+y(t.requests/2)}),m.exit().remove();var b=p.selectAll("circle.complied_requests").data(r,function(t){return t.company});b.enter().append("circle").attr("class","complied_requests").attr("cx",function(t){return y(t.x)}).attr("cy",function(){return v(o)}).attr("r","0"),b.on("mouseover",function(t){return l.html("<b>"+e("#t_total_requests").val()+"</b><span>"+t.requests+"</span><b>"+e("#t_information_produced").val()+"</b><span>"+t.complied+"</span>").style("top",f-y(t.requests/2)+20+"px").style("left",d+y(t.x)-60+"px").style("display","block")}).on("mouseout",function(){return l.style("display","none")}).transition().attr("cx",function(t){return y(t.x)}).attr("cy",function(){return v(o)}).attr("r",function(t){var e=t.complied/t.requests;return totalRad=2+y(t.requests/2),e*totalRad}),b.exit().remove();var h=p.selectAll("text.company").data(r,function(t){return t.company});h.enter().append("text").attr("class",function(t){return t.tiny?"out_of_circle":"in_circle"}).classed("company",!0),h.attr("class",function(t){return t.tiny?"out_of_circle":"in_circle"}).classed("company",!0).text(function(t){return t.company}).transition().attr("x",function(t){return y(t.x)}).attr("y",function(){return v(o)}).attr("dy",function(t,e){return t.tiny?u/2-30*(e+1):4}).attr("dx",function(t){return t.tiny?5:0}),h.exit().remove();var _=p.selectAll("line.bottomline").data(r,function(t){return t.company});_.enter().append("line").attr("class","bottomline"),_.transition().attr("x1",function(t){return y(t.x)}).attr("x2",function(t){return y(t.x)}).attr("y1",function(t){return v(o)+y(t.requests/2)+5}).attr("y2",function(t,e){return u-27*(e+2)}).style("opacity",function(t){return t.tiny?1:0}),_.exit().remove()}var o={top:10,right:10,bottom:10,left:10},s=e("#"+a).width()-o.left-o.right,u=e("#"+a).height()-o.top-o.bottom,c=t.select("#"+a).append("svg"),p=c.attr("width",s+o.left+o.right).attr("height",u+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"),d=e(c[0]).offset().left,f=e(p[0]).offset().top;i(r)},pieChart=function(a){function r(t){return t.startAngle+(t.endAngle-t.startAngle)/2}var n,l,i,o,s=e(".pieChart"),u=s.width(),c=s.height(),p=Math.min(u,c)/2;371>u?(n=.42*p,l=.4*p,i=t.svg.arc().outerRadius(.35*p).innerRadius(0),o=t.svg.arc().innerRadius(.4*p).outerRadius(.4*p)):431>u?(n=.5*p,l=.48*p,i=t.svg.arc().outerRadius(.35*p).innerRadius(0),o=t.svg.arc().innerRadius(.45*p).outerRadius(.45*p)):631>u?(n=.6*p,l=.58*p,i=t.svg.arc().outerRadius(.5*p).innerRadius(.35*p),o=t.svg.arc().innerRadius(.6*p).outerRadius(.6*p)):(n=p,l=.95*p,i=t.svg.arc().outerRadius(.6*p).innerRadius(.4*p),o=t.svg.arc().innerRadius(.95*p).outerRadius(.95*p));var d=t.select(".pieChart").append("svg").attr({width:u,height:c}).append("g");d.attr("transform","translate("+u/2+", "+c/2+")"),d.append("g").attr("class","lines"),d.append("g").attr("class","slices"),d.append("g").attr("class","labels");var f=["#36c","#335aa7","#334f82","#33435d","#343838"],y=t.layout.pie().value(function(t){return t[1]}).sort(null),v=d.select(".slices").datum(a).selectAll("path").data(y);v.enter().append("path").attr({fill:function(t,e){return f[e]},d:i,"class":"pieChart__slice"});var m=d.select(".labels").selectAll("text").data(y(a));m.enter().append("text").attr({dy:"0.35em","class":"pieChart__label",transform:function(t){var e=o.centroid(t);return e[0]=n*(r(t)<3.14?1:-1),"translate("+e+")"}}).style("text-anchor",function(t){return r(t)<3.14?"start":"end"}).text(function(t){return t.data[0]}),m.enter().append("text").attr({dy:"1.35em","class":"pieChart__label",transform:function(t){var e=o.centroid(t);return e[0]=n*(r(t)<3.14?1:-1),"translate("+e+")"}}).style("text-anchor",function(t){return r(t)<3.14?"start":"end"}).text(function(t){return" ( "+t.data[1]+" )"});var b=d.select(".lines").selectAll("polyline").data(y(a));b.enter().append("polyline").attr({points:function(t){var e=o.centroid(t);return e[0]=l*(r(t)<3.14?1:-1),[i.centroid(t),o.centroid(t),e]},"class":"pieChart__line"})},e(function(){function r(t){var e={};for(var a in t)e[a]=+t[a],isNaN(e[a])&&(e[a]=t[a]);return e}t.csv("./data/other_companies.csv",r,function(e,a){if(e)throw e;var r=t.dispatch("timerange"),n=t.select("body").append("div").attr("class","bubble_tooltip").style("display","none");bubbleGraph("compare_graph",a,r,n)}),t.csv("./data/sum.csv",r,function(r){function n(){e(".flagBorder").remove();var a=[].slice.call(document.querySelectorAll("#bar_graph_by_country .flag"));a.forEach(function(e){e.getAttribute("href")&&t.select("#bar_graph_by_country svg g").append("rect").attr({"class":"flagBorder",width:"24",height:"18",y:function(){return e.getAttribute("y")},x:function(){return e.getAttribute("x")}})})}var l={requests:[]};r.forEach(function(t){function e(e,a,r,n){for(var i=0;n>i;i++)l.requests.push({country:e,type:a,disclosed:r,duration:t.duration})}if(t.Total!==t["Criminal Subpoena"]+t["Informal Request"]+t.Government+t["Civil Subpoena"]+t.Warrant+t["Court orders"])throw new Error("The requests don't add up for "+t.Country);e(t.Country,"Criminal Subpoenas","All",t["Criminal Subpoena Complied (All)"]),e(t.Country,"Criminal Subpoenas","No",t["Criminal Subpoena"]-t["Criminal Subpoena Complied (Partial)"]-t["Criminal Subpoena Complied (All)"]),e(t.Country,"Criminal Subpoenas","Partial",t["Criminal Subpoena Complied (Partial)"]),e(t.Country,"Informal Non-Government Requests","All",t["Informal Request Complied (All)"]),e(t.Country,"Informal Non-Government Requests","No",t["Informal Request"]-t["Informal Request Complied (Partial)"]-t["Informal Request Complied (All)"]),e(t.Country,"Informal Non-Government Requests","Partial",t["Informal Request Complied (Partial)"]),e(t.Country,"Informal Government Requests","All",t["Government Complied (All)"]),e(t.Country,"Informal Government Requests","No",t.Government-t["Government Complied (Partial)"]-t["Government Complied (All)"]),e(t.Country,"Informal Government Requests","Partial",t["Government Complied (Partial)"]),e(t.Country,"Civil Subpoenas","All",t["Civil Subpoena Complied (All)"]),e(t.Country,"Civil Subpoenas","No",t["Civil Subpoena"]-t["Civil Subpoena Complied (Partial)"]-t["Civil Subpoena Complied (All)"]),e(t.Country,"Civil Subpoenas","Partial",t["Civil Subpoena Complied (Partial)"]),e(t.Country,"Warrant","All",t["Warrant Complied (All)"]),e(t.Country,"Warrant","No",t.Warrant-t["Warrant Complied (Partial)"]-t["Warrant Complied (All)"]),e(t.Country,"Warrant","Partial",t["Warrant Complied (Partial)"]),e(t.Country,"Court orders","All",t["Court orders complied (All)"]),e(t.Country,"Court orders","No",t["Court orders"]-t["Court orders complied (Partial)"]-t["Court orders complied (All)"]),e(t.Country,"Court orders","Partial",t["Court orders complied (Partial)"])}),r=l;var i=new a;i.init(r),i.filters.duration="juldec16";var o=t.dispatch("filter","timerange"),s=t.select("body").append("div").attr("class","graph_tooltip").style("display","none");horizontalGraph("bar_graph_by_country","country",i,o,s),horizontalGraph("bar_graph_by_type","type",i,o,s),e("#by_country_show_all").click(function(){delete i.filters.country,o.filter()}),e("#request_type_show_all").click(function(){delete i.filters.type,o.filter()});var u=e("#user_data_all"),c=e("#user_data_juldec16"),p=e("#partial"),d=e("#yes"),f=e("#no"),y=e("#all"),v=e("#none"),m=e(".graph_tooltip");e(".user_data_tabs").click(function(){e(".user_data_tabs").removeClass("active"),e(this).addClass("active");var t=e(this).attr("id").split("_")[2];"all"===t?delete i.filters.duration:i.filters.duration=t,delete i.filters.type,delete i.filters.country,e("#by_country_show_all, #request_type_show_all").addClass("disabled"),u.hasClass("active")||c.hasClass("active")?(p.removeClass("inactive"),y.removeClass("inactive"),v.removeClass("inactive"),d.addClass("inactive"),f.addClass("inactive"),m.removeClass("partialInactive")):(p.addClass("inactive"),y.addClass("inactive"),v.addClass("inactive"),d.removeClass("inactive"),f.removeClass("inactive"),m.addClass("partialInactive")),setTimeout(n,350),o.timerange()}),o.on("filter.show_all",function(){e("#by_country_show_all, #request_type_show_all").addClass("disabled"),i.filters.country&&e("#by_country_show_all").removeClass("disabled"),i.filters.type&&e("#request_type_show_all").removeClass("disabled")})}),t.csv("./data/number_of_disclosures.csv",function(t){var e=t.map(function(t){return[t.key,t.value]}),a=e.reduce(function(t,e){return t+parseInt(e[1])},0);pieChart(e);var r=document.querySelector(".totalValue");r.innerHTML="<span>Total</span><span class='colon'>:</span><span>"+a+"</span>"})})}(d3,jQuery);