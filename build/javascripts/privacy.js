!function(t,e){function a(t){return t.reduce(function(t,e){return t+=e},0)}function r(t){var e=t.slice();e.sort(function(t,e){var r=a(t.value),n=a(e.value);return r<n?1:r>n?-1:t.key.localeCompare(e.key)});for(var r,n=e.length,l=0;l<n;l++)if("Unknown"===e[l].key){r=l;break}var i=e.splice(r,1)[0];return e.push(i),e}function n(){}var l={Afghanistan:"af",Argentina:"ar",Australia:"au",Austria:"at",Azerbaijan:"az",Bangladesh:"bd",Belgium:"be","Bosnia and Herzegovina":"ba",Brazil:"br",Bulgaria:"bg",Canada:"ca",Chile:"cl",China:"cn",Colombia:"co","Costa Rica":"cr",Croatia:"hr",Cyprus:"cy","Czech Republic":"cz",Denmark:"dk","Dominican Republic":"do",Ecuador:"ec",Egypt:"eg",Estonia:"ee",Finland:"fi",France:"fr",Georgia:"ge",Germany:"de",Greece:"gr",Guatemala:"gt",Honduras:"hn","Hong Kong":"hk",Hungary:"hu",India:"in",Indonesia:"id",Iran:"ir",Ireland:"ie",Israel:"il",Italy:"it",Japan:"jp",Korea:"kr",Kosovo:"xk",Latvia:"lv",Lebanon:"lb",Libya:"ly",Liechtenstein:"li",Lithuania:"lt",Luxembourg:"lu",Macedonia:"mk",Malaysia:"my",Malta:"mt",Mexico:"mx",Morocco:"ma",Nepal:"np",Netherlands:"nl","New Zealand":"nz",Nigeria:"ng",Norway:"no",Pakistan:"pk","Papua New Guinea":"pg",Peru:"pe",Philippines:"ph",Poland:"pl",Portugal:"pt","Puerto Rico":"pr",Romania:"ro",Russia:"ru","Saudi Arabia":"sa",Senegal:"sn",Serbia:"rs",Singapore:"sg",Slovakia:"sk",Slovenia:"si","South Africa":"za","South Korea":"kr",Spain:"es","Sri Lanka":"lk",Suriname:"sr",Sweden:"se",Switzerland:"ch",Taiwan:"tw",Tanzania:"tz",Thailand:"th",Turkey:"tr",Uganda:"ug",Ukraine:"ua","United Kingdom":"gb",Uruguay:"uy",USA:"us",Uzbekistan:"uz",Venezuela:"ve"};n.prototype.init=function(t){if(0===t.length)throw new Error("Empty dataset");this.data=t.requests,this.filters={}},n.prototype.groupBy=function(t,e){function a(t,e){l[t[e]]||(l[t[e]]=[0,0,0])}function r(t,e){a(t,e);var r;switch(t.disclosed){case"All":r=0;break;case"No":r=1;break;case"Partial":r=2}l[t[e]][r]+=1}if(!this.data[0][t])throw new Error('No such column in dataset: "'+t+'" in: '+Object.keys(this.data[0]).join(", "));var n=this.data,l={};for(var i in n){var o=n[i],s=!1;if(this.filters===undefined||0===this.filters.length)s=!0;else{var u=!0;for(var c in this.filters){o[c]!==this.filters[c]&&(u=!1)}u&&(s=!0)}s?r(o,t):"undefined"!=typeof this.filters.duration&&o.duration!==this.filters.duration||a(o,t)}if(e){var p=[];for(var i in l)p.push({key:i,value:l[i]});return p}return l},horizontalGraph=function(a,n,i,o,s){function u(a,i,o,u,c,f,m){function b(t,e){return A.filter(function(a){return a.key===t&&a.disclosed===e})[0]}var _=r(i),g=40*_.length+40;p.height(g),v.attr("height",g),!0===m&&(k=t.scale.linear().domain([0,t.max(_,function(t){return t.value.reduce(function(t,e){return t+e})})]).range([0,y]));for(var C=[],x=0;x<_.length;x++)C.push(x);var o=t.scale.ordinal().domain(_.map(function(t){return t.key})).range(C),A=(a.append("line").attr("class","left-line").attr("x1",0).attr("x2",0).attr("y1",20).attr("y2",g-10),[]),q={};_.forEach(function(t){q[t.key]=t.value[0]+t.value[1]+t.value[2],A.push({key:t.key,disclosed:"all",value:t.value[0],x:t.value[1]+t.value[2]}),A.push({key:t.key,disclosed:"partial",value:t.value[2],x:t.value[1]}),A.push({key:t.key,disclosed:"no",value:t.value[1],x:0})});var w=a.selectAll("rect."+f).data(A,function(t){return t.key+t.disclosed});w.enter().append("rect").on("click",function(t){u.filters[n]===t.key?delete u.filters[n]:u.filters[n]=t.key,c.filter()}).attr("class",f),w.on("mouseover",function(a){var r="",n=Number(b(a.key,"all").value),l=Number(b(a.key,"partial").value),i=Number(b(a.key,"no").value),o=e(t.event.target).offset().top,c=h+k(q[a.key]);if(c+=d?50:30,d&&0!==Object.keys(u.filters).length&&"undefined"!=typeof u.filters.type){var p=u.groupBy("country")[a.key];r="<b>"+u.filters.type+"</b><span>"+(Number(p[0])+Number(p[1])+Number(p[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+p[0]+"</span><b class='partial-data'>"+e("#t_information_produced_partial").val()+"</b><span class='partial-data'>"+p[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+'</span><b class="partial-data">'+e("#t_information_produced_partial").val()+'</b><span class="partial-data">'+l+"</span>"),s.html(r).style("top",o+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return s.style("display","none")}).attr("height","12").attr("y",function(t){return 40*(o(t.key)+1)+3}).classed("disclosed--all",function(t){return"all"===t.disclosed}).classed("disclosed--partial",function(t){return"partial"===t.disclosed}).classed("disclosed--none",function(t){return"no"===t.disclosed}).transition().attr("x",function(t){return k(t.x)}).attr("width",function(t){return 0===t.value?0:k(t.value)}),w.exit().remove();var N=a.selectAll("text."+f).data(_);if(N.enter().append("text").on("click",function(t){u.filters[n]===t.key?delete u.filters[n]:u.filters[n]=t.key,c.filter()}).attr("class",f),N.on("mouseover",function(a){var r="",n=Number(b(a.key,"all").value),l=Number(b(a.key,"partial").value),i=Number(b(a.key,"no").value),o=e(t.event.target).offset().top+20,c=h+k(q[a.key]);if(c+=d?50:30,d&&0!==Object.keys(u.filters).length&&"undefined"!=typeof u.filters.type){var p=u.groupBy("country")[a.key];r="<b>"+u.filters.type+"</b><span>"+(Number(p[0])+Number(p[1])+Number(p[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+p[0]+"</span><b class='partial-data'>"+e("#t_information_produced_partial").val()+"</b><span class='partial-data'>"+p[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+'</span><b class="partial-data">'+e("#t_information_produced_partial").val()+'</b><span class="partial-data">'+l+"</span>"),s.html(r).style("top",o+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return s.style("display","none")}).attr("y",function(t,e){return 40*(e+1)}).attr("dy",-3).attr("x",5).text(function(t){var a="#t_";return a+=t.key.replace(/\W+/g," ").split(" ").join("_").toLowerCase(),e(a).val()}),N.exit().remove(),d){var R=a.selectAll("image."+f).data(_);R.enter().append("image").on("click",function(t){u.filters[n]===t.key?delete u.filters[n]:u.filters[n]=t.key,c.filter()}).attr("class",f).classed("flag",!0).each(function(t,e){"undefined"!=typeof l[t.key.split("*")[0]]&&a.append("rect").attr({"class":"flagBorder",width:"24",height:"18",y:function(){return 40*(e+1)-8},x:"-33"})}),R.on("mouseover",function(a){var r="",n=Number(b(a.key,"all").value),l=Number(b(a.key,"partial").value),i=Number(b(a.key,"no").value),o=e(t.event.target).offset().top+10,c=h+k(q[a.key]);if(c+=d?50:30,d&&0!==Object.keys(u.filters).length&&"undefined"!=typeof u.filters.type){var p=u.groupBy("country")[a.key];r="<b>"+u.filters.type+"</b><span>"+(Number(p[0])+Number(p[1])+Number(p[2]))+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+p[0]+"</span><b>"+e("#t_information_produced_partial").val()+"</b><span>"+p[2]+"</span>"}return""===r&&(r="<b>"+e("#t_total_requests").val()+"</b><span>"+(n+l+i)+"</span><b>"+e("#t_information_produced_all").val()+"</b><span>"+n+"</span><b>"+e("#t_information_produced_partial").val()+"</b><span>"+l+"</span>"),s.html(r).style("top",o+"px").style("left",c+"px").style("display","block")}).on("mouseout",function(){return s.style("display","none")}).attr("width",24).attr("height",18).attr("xlink:href",function(t){if("undefined"!=typeof l[t.key.split("*")[0]])return"./images/flags_svg/"+l[t.key.split("*")[0]]+".svg"}).attr("y",function(t,e){return 40*(e+1)-8}).attr("x",-33),R.exit().remove()}}for(var c=r(i.groupBy(n,!0)),p=e("#"+a),d=Object.keys(l).indexOf(c[0].key)>-1,f={top:10,right:10,bottom:10,left:d?40:20},y=p.width()-f.left-f.right,m=p.height()-f.top-f.bottom,v=t.select("#"+a).append("svg").attr("width",y+f.left+f.right).attr("height",m+f.top+f.bottom),b=v.append("g").attr("transform","translate("+f.left+","+f.top+")"),h=e(v[0]).offset().left,_=(b.append("line").attr("class","left-line").attr("x1",0).attr("x2",0).attr("y1",20).attr("y2",m-10),[]),g=0;g<c.length;g++)_.push(g);var C=t.scale.ordinal().domain(c.map(function(t){return t.key})).range(_),k=t.scale.linear().domain([0,t.max(c,function(t){return t.value.reduce(function(t,e){return t+e})})]).range([0,y]);u(b,c,C,i,o,"gray_bars",!0),u(b,c,C,i,o,"blue_bars",!0),o.on("filter."+a,function(){var t=i.groupBy(n,!0);u(b,t,C,i,o,"blue_bars",!0),u(b,t,C,i,o,"gray_bars")}),o.on("timerange."+a,function(){var t=i.groupBy(n,!0);u(b,t,C,i,o,"gray_bars",!0),u(b,t,C,i,o,"blue_bars",!0)})},bubbleGraph=function(a,r,n,l){function i(a){var r=a,n=t.max(r,function(t){return t.requests}),i=n/4,o=n/2,c=i;r.forEach(function(t){c+=t.requests/2,t.x=c,c+=t.requests/2,c+=i});var y=t.scale.linear().domain([0,c]).range([0,s]),m=t.scale.linear().domain([0,n]).range([0,u]);r.forEach(function(t){y(t.requests/2)<40&&(t.tiny=!0)});var v=p.selectAll("circle.all_requests").data(r,function(t){return t.company});v.enter().append("circle").attr("class","all_requests").attr("cx",function(t){return y(t.x)}).attr("cy",function(){return m(o)}).attr("r",0),v.on("mouseover",function(t){return l.html("<b>"+e("#t_total_requests").val()+"</b><span>"+t.requests+"</span><b>"+e("#t_information_produced").val()+"</b><span>"+t.complied+"</span>").style("top",f-y(t.requests/2)+20+"px").style("left",d+y(t.x)-60+"px").style("display","block")}).on("mouseout",function(){return l.style("display","none")}).transition().attr("cx",function(t){return y(t.x)}).attr("cy",function(){return m(o)}).attr("r",function(t){return 2+y(t.requests/2)}),v.exit().remove();var b=p.selectAll("circle.complied_requests").data(r,function(t){return t.company});b.enter().append("circle").attr("class","complied_requests").attr("cx",function(t){return y(t.x)}).attr("cy",function(){return m(o)}).attr("r","0"),b.on("mouseover",function(t){return l.html("<b>"+e("#t_total_requests").val()+"</b><span>"+t.requests+"</span><b>"+e("#t_information_produced").val()+"</b><span>"+t.complied+"</span>").style("top",f-y(t.requests/2)+20+"px").style("left",d+y(t.x)-60+"px").style("display","block")}).on("mouseout",function(){return l.style("display","none")}).transition().attr("cx",function(t){return y(t.x)}).attr("cy",function(){return m(o)}).attr("r",function(t){var e=t.complied/t.requests;return totalRad=2+y(t.requests/2),e*totalRad}),b.exit().remove();var h=p.selectAll("text.company").data(r,function(t){return t.company});h.enter().append("text").attr("class",function(t){return t.tiny?"out_of_circle":"in_circle"}).classed("company",!0),h.attr("class",function(t){return t.tiny?"out_of_circle":"in_circle"}).classed("company",!0).text(function(t){return t.company}).transition().attr("x",function(t){return y(t.x)}).attr("y",function(){return m(o)}).attr("dy",function(t,e){return t.tiny?u/2-30*(e+1):4}).attr("dx",function(t){return t.tiny?5:0}),h.exit().remove();var _=p.selectAll("line.bottomline").data(r,function(t){return t.company});_.enter().append("line").attr("class","bottomline"),_.transition().attr("x1",function(t){return y(t.x)}).attr("x2",function(t){return y(t.x)}).attr("y1",function(t){return m(o)+y(t.requests/2)+5}).attr("y2",function(t,e){return u-27*(e+2)}).style("opacity",function(t){return t.tiny?1:0}),_.exit().remove()}var o={top:10,right:10,bottom:10,left:10},s=e("#"+a).width()-o.left-o.right,u=e("#"+a).height()-o.top-o.bottom,c=t.select("#"+a).append("svg"),p=c.attr("width",s+o.left+o.right).attr("height",u+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"),d=e(c[0]).offset().left,f=e(p[0]).offset().top;i(r)},pieChart=function(a){function r(t){return t.startAngle+(t.endAngle-t.startAngle)/2}var n,l,i,o,s=e(".pieChart"),u=s.width(),c=s.height(),p=Math.min(u,c)/2;u<371?(n=.32*p,l=.3*p,i=t.svg.arc().outerRadius(.25*p).innerRadius(0),o=t.svg.arc().innerRadius(.3*p).outerRadius(.3*p)):u<431?(n=.45*p,l=.43*p,i=t.svg.arc().outerRadius(.3*p).innerRadius(0),o=t.svg.arc().innerRadius(.4*p).outerRadius(.4*p)):u<631?(n=.6*p,l=.58*p,i=t.svg.arc().outerRadius(.5*p).innerRadius(.35*p),o=t.svg.arc().innerRadius(.6*p).outerRadius(.6*p)):(n=p,l=.95*p,i=t.svg.arc().outerRadius(.6*p).innerRadius(.4*p),o=t.svg.arc().innerRadius(.8*p).outerRadius(.8*p));var d=t.select(".pieChart").append("svg").attr({width:u,height:c}).append("g");d.attr("transform","translate("+u/2+", "+c/2+")"),d.append("g").attr("class","lines"),d.append("g").attr("class","slices"),d.append("g").attr("class","labels");var f=["#36c","#878787","#ffbe3c","#343838"],y=t.layout.pie().value(function(t){return t[1]}).sort(null);d.select(".slices").datum(a).selectAll("path").data(y).enter().append("path").attr({fill:function(t,e){return f[e]},d:i,"class":"pieChart__slice"});var m=d.select(".labels").selectAll("text").data(y(a));m.enter().append("text").attr({dy:"0.35em","class":"pieChart__label",transform:function(t){var e=o.centroid(t);return e[0]=n*(r(t)<3.14?1:-1),"translate("+e+")"}}).style("text-anchor",function(t){return r(t)<3.14?"start":"end"}).text(function(t){return t.data[0]}),m.enter().append("text").attr({dy:"1.35em","class":"pieChart__label",transform:function(t){var e=o.centroid(t);return e[0]=n*(r(t)<3.14?1:-1),"translate("+e+")"}}).style("text-anchor",function(t){return r(t)<3.14?"start":"end"}).text(function(t){return" ( "+t.data[1]+" )"}),d.select(".lines").selectAll("polyline").data(y(a)).enter().append("polyline").attr({points:function(t){var e=o.centroid(t);return e[0]=l*(r(t)<3.14?1:-1),[i.centroid(t),o.centroid(t),e]},"class":"pieChart__line"})},e(function(){function a(t){var e={};for(var a in t)e[a]=+t[a],isNaN(e[a])&&(e[a]=t[a]);return e}t.csv("./data/other_companies.csv",a,function(e,a){if(e)throw e;var r=t.dispatch("timerange"),n=t.select("body").append("div").attr("class","bubble_tooltip").style("display","none");bubbleGraph("compare_graph",a,r,n)}),t.csv("./data/sum.csv",a,function(a){function r(){e(".flagBorder").remove(),[].slice.call(document.querySelectorAll("#bar_graph_by_country .flag")).forEach(function(e){e.getAttribute("href")&&t.select("#bar_graph_by_country svg g").append("rect").attr({"class":"flagBorder",width:"24",height:"18",y:function(){return e.getAttribute("y")},x:function(){return e.getAttribute("x")}})})}var l={requests:[]};a.forEach(function(t){function e(e,a,r,n){for(var i=0;i<n;i++)l.requests.push({country:e,type:a,disclosed:r,duration:t.duration})}if(t.Total!==t["Criminal Subpoena"]+t["Informal Request"]+t.Government+t["Civil Subpoena"]+t.Warrant+t["Court orders"])throw new Error("The requests don't add up for "+t.Country);e(t.Country,"Criminal Subpoenas","All",t["Criminal Subpoena Complied (All)"]),e(t.Country,"Criminal Subpoenas","No",t["Criminal Subpoena"]-t["Criminal Subpoena Complied (Partial)"]-t["Criminal Subpoena Complied (All)"]),e(t.Country,"Criminal Subpoenas","Partial",t["Criminal Subpoena Complied (Partial)"]),e(t.Country,"Informal Non-Government Requests","All",t["Informal Request Complied (All)"]),e(t.Country,"Informal Non-Government Requests","No",t["Informal Request"]-t["Informal Request Complied (Partial)"]-t["Informal Request Complied (All)"]),e(t.Country,"Informal Non-Government Requests","Partial",t["Informal Request Complied (Partial)"]),e(t.Country,"Informal Government Requests","All",t["Government Complied (All)"]),e(t.Country,"Informal Government Requests","No",t.Government-t["Government Complied (Partial)"]-t["Government Complied (All)"]),e(t.Country,"Informal Government Requests","Partial",t["Government Complied (Partial)"]),e(t.Country,"Civil Subpoenas","All",t["Civil Subpoena Complied (All)"]),e(t.Country,"Civil Subpoenas","No",t["Civil Subpoena"]-t["Civil Subpoena Complied (Partial)"]-t["Civil Subpoena Complied (All)"]),e(t.Country,"Civil Subpoenas","Partial",t["Civil Subpoena Complied (Partial)"]),e(t.Country,"Warrant","All",t["Warrant Complied (All)"]),e(t.Country,"Warrant","No",t.Warrant-t["Warrant Complied (Partial)"]-t["Warrant Complied (All)"]),e(t.Country,"Warrant","Partial",t["Warrant Complied (Partial)"]),e(t.Country,"Court orders","All",t["Court orders complied (All)"]),e(t.Country,"Court orders","No",t["Court orders"]-t["Court orders complied (Partial)"]-t["Court orders complied (All)"]),e(t.Country,"Court orders","Partial",t["Court orders complied (Partial)"])}),a=l;var i=new n;i.init(a),i.filters.duration="janjun18";var o=t.dispatch("filter","timerange"),s=t.select("body").append("div").attr("class","graph_tooltip").style("display","none");horizontalGraph("bar_graph_by_country","country",i,o,s),horizontalGraph("bar_graph_by_type","type",i,o,s),e("#by_country_show_all").click(function(){delete i.filters.country,o.filter()}),e("#request_type_show_all").click(function(){delete i.filters.type,o.filter()});e("#user_data_all"),e("#user_data_janjun18"),e("#partial"),e("#yes"),e("#no"),e("#all"),e("#none"),e(".graph_tooltip");e(".user_data_tabs").click(function(){e(".user_data_tabs").removeClass("active"),e(this).addClass("active");var t=e(this).attr("id").split("_")[2];"all"===t?delete i.filters.duration:i.filters.duration=t,delete i.filters.type,delete i.filters.country,e("#by_country_show_all, #request_type_show_all").addClass("disabled"),setTimeout(r,350),o.timerange()}),o.on("filter.show_all",function(){e("#by_country_show_all, #request_type_show_all").addClass("disabled"),i.filters.country&&e("#by_country_show_all").removeClass("disabled"),i.filters.type&&e("#request_type_show_all").removeClass("disabled")})}),t.csv("./data/number_of_disclosures.csv",function(t){var e=t.map(function(t){return[t.key,t.value]}),a=e.reduce(function(t,e){return t+parseInt(e[1])},0);pieChart(e),document.querySelector(".totalValue").innerHTML="<span>Total</span><span class='colon'>:</span><span>"+a+"</span>"})})}(d3,jQuery);